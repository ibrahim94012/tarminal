const term=document.getElementById("terminal"),input=document.getElementById("cmdInput"),sendBtn=document.getElementById("sendBtn");function writeLine(e=""){let t=document.createElement("div");t.className="line",t.innerHTML=e,term.appendChild(t),term.scrollTop=term.scrollHeight}function promptText(){return'<span class="prompt">josna:$</span>'}function now(){return new Date().toLocaleString("en-US",{timeZone:"Asia/Dhaka"})}let unlocked=!1,vaultData={entries:[]};async function showIntro(){writeLine(`<strong>Terminal Opening</strong> <span class="muted">(${now()})</span>`),writeLine('<span class="muted">type <code>help</code> to see available commands.</span>')}function showHelp(){writeLine(`<div class="muted">
    <div><code>help</code> ----------------------- কমান্ড তালিকা</div>
    <div><code>add</code> ------------------------ নতুন এন্ট্রি যোগ</div>
    <div><code>list</code> ----------------------- সব এন্ট্রি</div>
    <div><code>view "id"</code> ------------------ নির্দিষ্ট এন্ট্রি</div>
    <div><code>export</code> --------------------- JSON ডাউনলোড</div>
    <div><code>import</code> --------------------- JSON থেকে restore</div>
    <div><code>change-pin</code> ----------------- PIN পরিবর্তন (not allowed)</div>
    <div><code>lock</code> ----------------------- লক</div>
    <div><code>clear</code> ---------------------- টার্মিনাল পরিষ্কার</div>
    <div><code>unlock</code> --------------------- PIN দিয়ে আনলক</div></div>`)}async function ask(e,t={mask:!1}){return writeLine(promptText()+` <strong>${e}</strong>`),input.disabled=!0,sendBtn.disabled=!0,new Promise(e=>{let n=document.createElement("div"),a=document.createElement("input");a.type=t.mask?"password":"text",a.style.width="100%",a.style.background="#0f0f0f",a.style.color="var(--text)",n.appendChild(a),term.appendChild(n),term.scrollTop=term.scrollHeight,a.focus(),a.addEventListener("keydown",t=>{if("Enter"===t.key){let i=a.value;n.remove(),input.disabled=!1,sendBtn.disabled=!1,input.focus(),e(i)}})})}async function commandAdd(){if(!unlocked)return writeLine("\uD83D\uDD12 Vault locked");let e="addForm-"+Date.now(),t=`
    <form id="${e}" class="vault-form" style="margin:10px 0; padding:12px; background:#1a1a1a; border:1px solid #333; border-radius:10px; max-width:400px;">
      <h3 style="margin-top:0; color:#f6b544;">➕ Add New Entry</h3>

      <label style="display:block; margin:6px 0 2px;">Platform/Service</label>
      <input type="text" name="platform" required style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;">

      <label style="display:block; margin:6px 0 2px;">Username</label>
      <input type="text" name="username" style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;">

      <label style="display:block; margin:6px 0 2px;">Email</label>
      <input type="email" name="email" style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;">

      <label style="display:block; margin:6px 0 2px;">Mobile</label>
      <input type="text" name="mobile" style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;">

      <label style="display:block; margin:6px 0 2px;">Password</label>
      <input type="password" name="password" required style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;">

      <label style="display:block; margin:6px 0 2px;">Note</label>
      <textarea name="note" rows="2" style="width:100%; padding:6px; background:#222; color:#fff; border:1px solid #444; border-radius:6px;"></textarea>

      <div style="margin-top:10px;">
        <button type="submit" id="${e}-submit" style="margin-right:10px; background:#f6b544; border:none; padding:6px 14px; border-radius:6px; cursor:pointer; color:#111;">Submit</button>
        <button type="button" id="${e}-cancel" style="background:#444; border:none; padding:6px 14px; border-radius:6px; cursor:pointer; color:#fff;">Cancel</button>
      </div>
    </form>
  `;writeLine(t);let n=document.getElementById(e),a=document.getElementById(e+"-cancel"),i=document.getElementById(e+"-submit");a.onclick=()=>{n.remove(),writeLine("❌ Entry cancelled")},n.onsubmit=async e=>{e.preventDefault(),i.disabled=!0,i.style.opacity="0.6",i.textContent="⏳ Saving...";let t=new FormData(n),a={id:Date.now().toString(36),platform:t.get("platform")?.trim()||"-",username:t.get("username")?.trim()||"-",email:t.get("email")?.trim()||"-",mobile:t.get("mobile")?.trim()||"-",password:t.get("password")?.trim()||"-",note:t.get("note")?.trim()||"-",created:new Date().toISOString()};vaultData.entries.push(a);try{let o=new FormData;for(let[r,l]of Object.entries(a))o.append(r,l);let s=await fetch("https://script.google.com/macros/s/AKfycbxXAZAZOM-MjHZs5z9i90WXyLyKMIOu0qU5H1ab0KJx8e-9VU4aQtL0ZwvHZiWjAthPww/exec",{method:"POST",mode:"cors",body:o});if(s.ok){let d=await s.text();console.log("✅ Google Sheet Success!",d),writeLine(`✅ Added <span class="idtag">${a.id}</span> (${a.platform})`)}else console.warn("⚠️ Google Sheet returned non-200:",s.status),writeLine("⚠️ Could not save to Google Sheet (server error). Saved locally only.")}catch(c){console.error("❌ Google Sheet Network Error!",c),writeLine("❌ Network error — entry saved locally only.")}i.disabled=!1,i.style.opacity="1",i.textContent="Submit",n.remove()}}async function commandExport(){if(!unlocked)return writeLine("\uD83D\uDD12 Vault locked");let e=new Blob([JSON.stringify(vaultData,null,2)],{type:"application/json"}),t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download="josna.json",document.body.appendChild(n),n.click(),n.remove(),URL.revokeObjectURL(t),writeLine("⬇️ josna.json exported")}async function commandImport(){if(!unlocked)return writeLine("\uD83D\uDD12 Vault locked");let e=document.createElement("input");e.type="file",e.accept="application/json",e.style.display="none",document.body.appendChild(e),e.onchange=async()=>{let t=e.files[0];if(!t)return;let n=await t.text();try{let a=JSON.parse(n);if(!Array.isArray(a.entries))return writeLine("Invalid file");vaultData=a,writeLine("✅ Imported")}catch(i){writeLine("Invalid JSON")}e.remove()},e.click()}async function commandList(){if(!unlocked)return writeLine("\uD83D\uDD12 Vault locked");let e=`https://sheets.googleapis.com/v4/spreadsheets/1GOKMUAeNefOMPE8KflSIqeoodHYFesaD6aJgRGCi5Ng/values/${encodeURIComponent("Sheet12!A:Z")}?key=AIzaSyACww_yoqNc1ZnF14GTf-WmOR0_gYO8bms`;try{let t=await fetch(e);if(!t.ok){writeLine("❌ Google Sheet fetch failed");return}let n=await t.json(),a=n.values||[];if(a.length<=1)return writeLine("— no entries —");for(let i=1;i<a.length;i++){let o=a[i],r=o[0]||"-",l=o[1]||"-",s=o[2]||"-",d=o[3]||"-",c=o[4]||"-";writeLine(`
        <div class="list-item"><span class="idtag copy-id" data-id="${r}">${r}</span> — <strong>${l}</strong> <span class="muted">${s}</span> <span class="muted">${d} ${c}</span></div>`)}}catch(p){writeLine("⚠️ Network error: "+p.message)}}function showNotification(e){let t=document.createElement("div");t.textContent=e,t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.background="#333",t.style.color="#fff",t.style.padding="8px 12px",t.style.borderRadius="6px",t.style.zIndex="9999",document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}async function commandView(e){if(!unlocked)return writeLine("\uD83D\uDD12 Vault locked");let t=`https://sheets.googleapis.com/v4/spreadsheets/1GOKMUAeNefOMPE8KflSIqeoodHYFesaD6aJgRGCi5Ng/values/${encodeURIComponent("Sheet12!A:Z")}?key=AIzaSyACww_yoqNc1ZnF14GTf-WmOR0_gYO8bms`;try{let n=await fetch(t);if(!n.ok){writeLine("❌ Google Sheet fetch failed");return}let a=await n.json(),i=a.values||[],o=i.find((t,n)=>n>0&&t[0]===e);if(!o)return writeLine("Not found");let r=o[1]||"-",l=o[2]||"-",s=o[3]||"-",d=o[4]||"-",c=o[5]||"-",p=o[6]||"-",m=o[7]||"-";writeLine(`<div class="viewModel"><strong>${r}</strong> [${e}] <span class="muted">${m}</span><br>
Username : ${l}<br>
Mobile   : ${s}<br>
Email    : ${d}<br>
Password : ${c}<br>
Note     : ${p}</div>`)}catch(u){writeLine("⚠️ Network error: "+u.message)}}function getDhakaHMParts(){let e=new Intl.DateTimeFormat("en-US",{timeZone:"Asia/Dhaka",hour:"2-digit",minute:"2-digit",hour12:!0}),t=e.formatToParts(new Date),n=t.find(e=>"hour"===e.type).value,a=t.find(e=>"minute"===e.type).value;return{hour:parseInt(n,10),minute:parseInt(a,10)}}function getDynamicPin(){let{hour:e,minute:t}=getDhakaHMParts();return`${e}${t}`}async function askPin(e){let t=getDynamicPin(),n="string"==typeof e&&""!==e.trim()?e.trim():await ask("Enter PIN",{mask:!0});n===t?(unlocked=!0,writeLine(`✅ Vault unlocked`)):writeLine(`<span style="color:#ef4444">⚠ Wrong PIN</span> <span style="color:#888888">(please try again)</span>`)}async function handleCommand(e){let[t,...n]=e.trim().split(/\s+/),a=n.join(" ");switch(t){case"help":showHelp();break;case"add":await commandAdd();break;case"list":await commandList();break;case"view":await commandView(a);break;case"export":await commandExport();break;case"import":await commandImport();break;case"change-pin":writeLine("ℹ️ PIN is fixed — cannot be changed manually");break;case"lock":unlocked=!1,writeLine("\uD83D\uDD12 Locked");break;case"clear":term.innerHTML="";break;case"unlock":await askPin(a);break;default:writeLine(`<span style="color:#ef4444">⚠ Unknown command: "${t}"</span>`),writeLine('Available: <span style="color:#888888">help, add, list, view, export, import, change-pin, lock, clear, unlock</span>')}}sendBtn.onclick=async()=>{let e=input.value.trim();e&&(writeLine(promptText()+` <strong>${e}</strong>`),input.value="",await handleCommand(e),input.focus())},input.onkeydown=e=>{"Enter"===e.key&&sendBtn.click()},(async()=>{showIntro(),writeLine("⏳ Use <code>pin</code> command to unlock.")})(),function(){let e=document.createElement("div");Object.assign(e.style,{position:"fixed",zIndex:2147483647,padding:"8px 14px",borderRadius:"8px",background:"rgba(0,0,0,0.85)",color:"#fff",fontFamily:"Inter, system-ui, sans-serif",fontSize:"13px",boxShadow:"0 6px 18px rgba(0,0,0,0.5)",transition:"opacity .2s ease, transform .2s ease",opacity:"0",pointerEvents:"none",transform:"translateY(8px)"}),document.body.appendChild(e);let t;async function n(e){try{return await navigator.clipboard.writeText(e),!0}catch{let t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.select();let n=document.execCommand("copy");return document.body.removeChild(t),n}}document.addEventListener("dblclick",async a=>{var i,o,r;let l=a.target;if(!l)return;let s="";s=l.nodeType===Node.TEXT_NODE?l.textContent.trim():(s=l.innerText||l.textContent||"").trim();let d=window.getSelection(),c=d&&d.toString().trim();if(c&&(s=c),!s)return;let p=await n(s),m=p?`কপি হয়েছে: "${s}"`:`কপি করা যায়নি`;i=m,o=a.clientX,r=a.clientY,e.textContent=i,e.style.left=`${o+10}px`,e.style.top=`${r-40}px`,e.style.opacity="1",e.style.transform="translateY(0px)",clearTimeout(t),t=setTimeout(()=>{e.style.opacity="0",e.style.transform="translateY(8px)"},1500)})}();